rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // User Profiles: Users can only read their own role/profile
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Role assignment should be handled via Admin/Cloud Functions
    }

    // Classroom Infrastructure State
    match /classroom_state/{document} {
      // All authenticated staff can monitor the state
      allow read: if request.auth != null;
      
      // ONLY users with the 'hod' role stored in their user document can toggle locks
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'hod';
    }

    // System Alerts & Notifications
    match /alerts/{alertId} {
      allow read: if request.auth != null;
      allow write: if false; // Alerts are generated by AI/System only
    }
  }
}
